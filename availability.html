{% extends "base.html" %}
{% block title %}Availability{% endblock %}
{% block content %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  const cells = document.querySelectorAll(".cell");
  let firstClickedCell = null;
  let secondClickedCell = null;
  let colorToApply = null; // Store the color of the first clicked cell

  cells.forEach((cell) => {
    cell.addEventListener("click", function () {
      if (!firstClickedCell) {
        firstClickedCell = cell;
        colorToApply = firstClickedCell.classList.contains("cal-red") ? "cal-green" : "cal-red"; // Store the color opposite of the first clicked cell
        highlightCells(firstClickedCell);
      } else if (!secondClickedCell) {
        secondClickedCell = cell;
        applyColorChange(colorToApply); // Apply the stored color to the highlighted cells
        firstClickedCell = null;
        secondClickedCell = null;
      }
    });

    cell.addEventListener("mouseover", function () {
      if (firstClickedCell && !secondClickedCell) {
        highlightCells(cell);
      }
    });
  });

  function highlightCells(targetCell) {
    const startIndex = Array.from(cells).indexOf(firstClickedCell);
    const endIndex = Array.from(cells).indexOf(targetCell);

    cells.forEach((cell, index) => {
      if (index >= Math.min(startIndex, endIndex) && index <= Math.max(startIndex, endIndex)) {
        cell.classList.add("cal-highlight");
      } else {
        cell.classList.remove("cal-highlight");
      }
    });
  }

  function applyColorChange(color) {
    const highlightedCells = document.querySelectorAll(".cal-highlight");
    highlightedCells.forEach((cell) => {
      cell.classList.remove("cal-green", "cal-red", "cal-highlight");
      cell.classList.add(color);
      cell.querySelector("input[type='hidden']").value = color === "cal-red" ? "True" : "False";
    });
  }
});


document.addEventListener("DOMContentLoaded", function () {
  const urlParams = new URLSearchParams(window.location.search);
  const saved = urlParams.get('saved');

  if (saved === "true") {
    $('#successModal').modal('show');
  }
});

$(document).ready(function() {
    $('form').submit(function(e) {
        e.preventDefault();  // Prevent the default form submission

        // Serialize form data
        var formData = $(this).serialize();

        // Send AJAX request to server
        $.ajax({
            url: 'availability',  // Update with your server endpoint
            method: 'POST',  // Use the appropriate HTTP method
            data: formData,
            success: function(response) {
                $('#modalMessage').text(response.message);
                $('#successModal').modal('show');
            },
            error: function(xhr, status, error) {
                // Handle error response from server
            }
        });
    });
});
</script>


<div class="col-md-2">
</div>

<div class="col-md-8"> <!-- center col -->

  <div class="row">

  <h2 class="page-header">HP Sand Volleyball {{ year }}</h2>

  </div> <!-- row -->

  <div class="row">

  <form class="form-horizontal" action="availability" method="post">
  <div class="col-sm-12">

    <!-- Committed -->
    <div class="panel panel-default">
      <div class="panel-heading">
        <H4>{{ player.name }}'s Availability</H4>
      </div>
	  <div>
		<p>Please verify your availability to play on the below dates. Games start at noon, and may not finish by 1:00. Make sure the days you can play are green and the days you cannot play are red. The system will automatically add holidays and global conflicts to your calendar.</p>
		<p class="text-danger"><strong>The system will prioritize scheduling people who have been scheduled less-often, but please note that the more days in a week where you are available, the more likely you will be scheduled to play.</strong></p>
	  </div>
      <table class="table table-striped table-condensed">
        <tr>
            <th></th>
            <th><div style="vertical-align:middle; text-align:center">Mon</div></th>
            <th><div style="vertical-align:middle; text-align:center">Tue</div></th>
            <th><div style="vertical-align:middle; text-align:center">Wed</div></th>
            <th><div style="vertical-align:middle; text-align:center">Thu</div></th>
            <th><div style="vertical-align:middle; text-align:center">Fri</div></th>
        </tr>
        {% for week_dates in weeks %}
            <tr>
              <th>Week {{ week_dates[0][0] + 1 }}</th>
              {% for week_index, date_index, date_info in week_dates %}
                <td  class="cell {% if fto_week[week_index][date_index] %}cal-red{% else %}cal-green{% endif %}">
                  {{ date_info }}
                  <input type="hidden" name="{{week_index+1}}-{{date_index+1}}" value="{% if fto_week[week_index][date_index] %}True{% else %}False{% endif %}"></input>
                </td>
              {% endfor %}
            </tr>
        {% endfor %}
            <tr><th> </th></tr>
      </table>{%
      if user %}{%
	  if player.id != user.user_id() %}
	  <input type="hidden" name="pid" value="{{player.id}}"></input>{%
	  endif %}{%
	  endif %}
      <button id="save" name="action" type="submit" class="btn btn-success btn-block" value="Save">
            <span class="glyphicon glyphicon-ok-sign" aria-hidden="true"></span> Save
      </button>
    </div>
  </div>

  </form>
  </div> <!-- row -->



</div> <!-- center col -->

<div class="col-md-2">
</div>



{% endblock %}